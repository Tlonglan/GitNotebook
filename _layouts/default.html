<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    {% if page.title %}{{ page.title }} | {% endif %}
    {{ site.title | default: "未命名站点" }}
  </title>
  
  <!-- 引入KaTeX资源 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 页面样式 - 蓝色主题 -->
  <style>
    :root {
      --primary-color: #165DFF;      /* 主色调：蓝色 */
      --secondary-color: #0E42B3;    /* 次色调：深蓝色 */
      --text-color: #333333;         /* 文本颜色 */
      --light-bg: #F5F7FA;           /* 浅色背景 */
      --border-color: #E5E9F2;       /* 边框颜色 */
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      color: var(--text-color);
    }
    
    /* 侧边栏导航 */
    #sidebar {
      width: 240px;
      background-color: var(--light-bg);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      overflow-y: auto;
      position: fixed;
      height: 100%;
    }
    
    #site-nav {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    
    .nav-item {
      margin-bottom: 8px;
    }
    
    .nav-item a {
      color: var(--text-color);
      text-decoration: none;
      display: block;
      padding: 6px 10px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .nav-item a:hover {
      background-color: rgba(22, 93, 255, 0.1);
      color: var(--primary-color);
    }
    
    .nav-item.active > a {
      background-color: var(--primary-color);
      color: white;
    }
    
    .has-children > a::after {
      content: "\f0da";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      float: right;
      transition: transform 0.2s;
    }
    
    .has-children.expanded > a::after {
      transform: rotate(90deg);
    }
    
    .sub-nav {
      list-style-type: none;
      padding-left: 20px;
      margin-top: 4px;
      display: none;
    }
    
    .expanded > .sub-nav {
      display: block;
    }
    
    /* 主内容区 */
    #main-content {
      flex: 1;
      margin-left: 240px;
      padding: 40px;
      max-width: 1000px;
    }
    
    .markdown-body {
      font-size: 16px;
    }
    
    /* 标题样式 */
    h1, h2, h3, h4, h5, h6 {
      color: var(--primary-color);
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    
    h1 {
      font-size: 2em;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.3em;
    }
    
    /* 链接样式 */
    a {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    a:hover {
      color: var(--secondary-color);
      text-decoration: underline;
    }
    
    /* 图片样式 */
    figure {
      text-align: center;
      margin: 24px 0;
    }
    
    figcaption {
      font-size: 0.9em;
      color: #666;
      margin-top: 8px;
    }
    
    /* 代码块样式 */
    pre {
      background-color: #f8f9fa;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 16px;
      overflow-x: auto;
    }
    
    code {
      font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9em;
      background-color: rgba(27, 31, 35, 0.05);
      padding: 0.2em 0.4em;
      border-radius: 3px;
    }
    
    /* 表格样式 */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    th, td {
      padding: 8px;
      border: 1px solid var(--border-color);
    }
    
    th {
      background-color: var(--light-bg);
    }
    
    /* 按钮样式 */
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: var(--secondary-color);
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      #sidebar {
        width: 100%;
        position: static;
        height: auto;
      }
      
      #main-content {
        margin-left: 0;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- 侧边栏导航 -->
  <div id="sidebar">
    <h2 class="sidebar-title" style="color: var(--primary-color);">{{ site.title }}</h2>
    <ul id="site-nav">
      {% assign pages_sorted = site.pages | sort: "path" %}
      {% assign root_pages = "" | split: "," %}
      {% assign dirs = "" | split: "," %}
      
      <!-- 收集根目录页面和目录 -->
      {% for page in pages_sorted %}
        {% assign ext = page.path | split: '.' | last | downcase %}
        {% assign is_static_resource = false %}
        
        <!-- 定义不需要显示在导航中的文件类型 -->
        {% assign static_exts = "css,js,json,xml,svg,png,jpg,jpeg,gif,ico,woff,woff2,ttf,eot,map" | split: ',' %}
        {% if static_exts contains ext %}
          {% assign is_static_resource = true %}
        {% endif %}
        
        <!-- 收集根目录页面和目录 -->
        {% if page.content.size > 10 and is_static_resource == false and page.url != "/" %}
          {% assign parts = page.path | split: '/' %}
          {% if parts.size == 1 %}
            <!-- 根目录页面 -->
            {% assign root_pages = root_pages | push: page %}
          {% else %}
            <!-- 子目录 -->
            {% assign dir = parts[0] %}
            {% unless dirs contains dir %}
              {% assign dirs = dirs | push: dir %}
            {% endunless %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      <!-- 生成根目录页面 -->
      {% for page in root_pages %}
        <li class="nav-item {% if page.url == page.url %}active{% endif %}">
          <a href="{{ page.url | relative_url }}">
            {% assign page_title = page.title | default: (page.name | replace: '.md', '' | replace: '-', ' ' | capitalize) %}
            {{ page_title }}
          </a>
        </li>
      {% endfor %}
      
      <!-- 生成目录导航（支持多级） -->
      {% for dir in dirs %}
        {% assign dir_pages = pages_sorted | where_exp: "page", "page.path contains dir" | where_exp: "page", "page.path != dir" %}
        {% assign has_pages = false %}
        
        <!-- 检查目录下是否有页面 -->
        {% for page in dir_pages %}
          {% assign parts = page.path | split: '/' %}
          {% if parts.size == 2 %}
            {% assign has_pages = true %}
            {% break %}
          {% endif %}
        {% endfor %}
        
        <!-- 如果目录下有页面，则生成导航项 -->
        {% if has_pages %}
          <li class="nav-item has-children {% if page.url contains dir %}expanded{% endif %}">
            <a href="#" class="{% if page.url contains dir %}active{% endif %}">
              {{ dir | replace: '-', ' ' | capitalize }}
            </a>
            <ul class="sub-nav">
              <!-- 生成一级子目录页面 -->
              {% for page in dir_pages %}
                {% assign parts = page.path | split: '/' %}
                {% if parts.size == 2 %}
                  <li>
                    <a href="{{ page.url | relative_url }}" class="{% if page.url == page.url %}active{% endif %}">
                      {% assign page_title = page.title | default: (parts[1] | replace: '.md', '' | replace: '-', ' ' | capitalize) %}
                      {{ page_title }}
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
              
              <!-- 生成二级子目录 -->
              {% assign sub_dirs = "" | split: "," %}
              {% for page in dir_pages %}
                {% assign parts = page.path | split: '/' %}
                {% if parts.size > 2 %}
                  {% assign sub_dir = parts[1] %}
                  {% unless sub_dirs contains sub_dir %}
                    {% assign sub_dirs = sub_dirs | push: sub_dir %}
                  {% endunless %}
                {% endif %}
              {% endfor %}
              
              {% for sub_dir in sub_dirs %}
                {% assign sub_dir_pages = dir_pages | where_exp: "page", "page.path contains sub_dir" %}
                <li class="nav-item has-children {% if page.url contains sub_dir %}expanded{% endif %}">
                  <a href="#" class="{% if page.url contains sub_dir %}active{% endif %}">
                    {{ sub_dir | replace: '-', ' ' | capitalize }}
                  </a>
                  <ul class="sub-nav">
                    {% for page in sub_dir_pages %}
                      {% assign parts = page.path | split: '/' %}
                      {% if parts.size == 3 %}
                        <li>
                          <a href="{{ page.url | relative_url }}" class="{% if page.url == page.url %}active{% endif %}">
                            {% assign page_title = page.title | default: (parts[2] | replace: '.md', '' | replace: '-', ' ' | capitalize) %}
                            {{ page_title }}
                          </a>
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </li>
              {% endfor %}
            </ul>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
  
  <!-- 主内容区 -->
  <div id="main-content">
    <article class="markdown-body">
      {% assign page_title = page.title | default: "无标题文档" %}
      {% if page_title != "无标题文档" %}
        <h1 style="color: var(--primary-color); margin-bottom: 1.5rem;">{{ page_title }}</h1>
      {% endif %}
      {{ content }}
    </article>
  </div>
  
  <!-- 脚本 -->
<script>
    function loadScript(url, callback) { /* ... */ } // 保持不变
    
    function reRenderMath() { /* 新增公式重渲染函数 */
      if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.body, {
          delimiters: [/* ... */],
          throwOnError: false
        });
      }
    }

    function loadPage(url) { /* 修改后的加载函数 */
      fetch(url)
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newContent = doc.querySelector('article.markdown-body').innerHTML;
          
          document.querySelector('article.markdown-body').innerHTML = newContent;
          reRenderMath(); // 关键：跳转后重渲染公式
          
          document.title = doc.title;
          const currentPath = window.location.pathname;
          const links = document.querySelectorAll('#site-nav a');
          
          links.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === currentPath) {
              link.classList.add('active');
              let parentItem = link.closest('.nav-item');
              while (parentItem && parentItem.closest('.has-children')) {
                parentItem = parentItem.closest('.has-children');
                parentItem.classList.add('expanded');
              }
            }
          });
          Prism.highlightAll(); // 如需代码高亮，保留此句
        })
        .catch(error => console.error('加载页面出错:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
      // 导航折叠逻辑不变
      const navItems = document.querySelectorAll('.has-children > a');
      navItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          this.parentElement.classList.toggle('expanded');
        });
      });
      
      // 初始加载时的公式渲染
      loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js', () => {
        loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js', () => {
          setTimeout(reRenderMath, 100); // 初始加载时延迟渲染
        });
      });
    });

    // 导航链接点击事件（无刷新跳转）
    document.addEventListener('click', function(e) {
      if (e.target.tagName === 'A' && e.target.closest('#site-nav')) {
        e.preventDefault();
        const href = e.target.getAttribute('href');
        if (href && href !== '#') {
          history.pushState(null, null, href);
          loadPage(href);
        }
      }
    });

    // 处理浏览器前进/后退
    window.addEventListener('popstate', () => {
      loadPage(window.location.pathname);
    });
  </script>
</body>
</html>